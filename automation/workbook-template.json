{
  "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "workbookDisplayName": {
      "type": "string",
      "metadata": {
        "description": "Display name for the workbook. E.g. 'Client01 - LOGS Drill Down'"
      }
    },
    "workbookType": {
      "type": "string",
      "defaultValue": "workbook",
      "metadata": {
        "description": "Workbook gallery type. Usually 'workbook'."
      }
    },
    "workbookSourceId": {
      "type": "string",
      "metadata": {
        "description": "Full resource ID of the Application Insights component for this system."
      }
    },
    "workbookId": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "metadata": {
        "description": "Unique GUID for this workbook instance."
      }
    }
  },
  "variables": {
    "serializedDataTemplate": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":1,\"content\":{\"json\":\"This workbook is intended for operational monitoring only.\\r\\n\\r\\nOperators must NOT:\\r\\nâ€¢ Edit queries\\r\\nâ€¢ Change visualizations\\r\\nâ€¢ Modify parameters\\r\\nâ€¢ Clone or delete this workbook\\r\\n\\r\\nFor changes or improvements, contact : J.your-team-contactÃ½ (OpsTeam).\",\"style\":\"warning\"},\"name\":\"text - 9\"},{\"type\":1,\"content\":{\"json\":\"This workbook is used for daily and ad-hoc monitoring of system errors.\\r\\n\\r\\nIt provides:\\r\\nâ€¢ A high-level overview of the most frequent and impactful errors\\r\\nâ€¢ A drill-down view with concrete log entries for investigation\\r\\nâ€¢ A consistent workflow for operators without technical knowledge\\r\\n\\r\\nThis workbook is READ-ONLY for operators.\\r\\nQueries and logic must not be modified.\",\"style\":\"info\"},\"name\":\"text - 7\"},{\"type\":1,\"content\":{\"json\":\"Follow this standard workflow:\\r\\n\\r\\n1. Select the time range using the Time Picker (top left)\\r\\n   Recommended options:\\r\\n   â€¢ Last 24 hours\\r\\n   â€¢ Last 7 days\\r\\n\\r\\n2. Review the \\\"Error Summary\\\" table\\r\\n   â€¢ Errors are ordered by number of occurrences\\r\\n\\r\\n3. Click on a row (error type) to see detailed logs below\\r\\n\\r\\n4. In the detail table, look for:\\r\\n   â€¢ ErrorId\\r\\n   â€¢ UserId\\r\\n   â€¢ OperationId\\r\\n   â€¢ Timestamp\\r\\n\\r\\n5. Use this information when escalating or creating a ticket\",\"style\":\"success\"},\"name\":\"text - 8\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"35fd1ce2-9e43-4cf2-89b0-ddf867b14f5b\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"TimeRange\",\"type\":4,\"isRequired\":true,\"typeSettings\":{\"selectableValues\":[{\"durationMs\":1800000},{\"durationMs\":3600000},{\"durationMs\":86400000},{\"durationMs\":604800000}],\"allowCustom\":true},\"timeContext\":{\"durationMs\":86400000},\"value\":{\"durationMs\":86400000}}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.insights/components\"},\"name\":\"parameters - 2\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let WarnMsgs = dynamic([\\r\\n    \\\"There was an error returned from customer's system\\\",\\r\\n    \\\"Failed to get response from method ProcessTransaction. Operation will be retried.\\\",\\r\\n    \\\"Failed to get response from method ProcessPayout. Operation will be retried.\\\",\\r\\n    \\\"Failed to get response from method CloseSession. Operation will be retried.\\\",\\r\\n    \\\"Failed to get response from method EndSession. Operation will be retried.\\\"\\r\\n]);\\r\\n\\r\\nlet ExcludeMsgs = dynamic([\\r\\n    \\\"User session does not exist\\\",\\r\\n    \\\"Unable to obtain user session\\\",\\r\\n    \\\"Getting currency rate from currency service failed.\\\"\\r\\n]);\\r\\n\\r\\nunion isfuzzy=true\\r\\n(\\r\\n    traces\\r\\n    | where timestamp {TimeRange}\\r\\n    | extend levelText = tolower(coalesce(\\r\\n        tostring(customDimensions[\\\"level\\\"]),\\r\\n        tostring(customDimensions[\\\"Level\\\"]),\\r\\n        tostring(customDimensions[\\\"loglevel\\\"]),\\r\\n        tostring(customDimensions[\\\"LogLevel\\\"])\\r\\n    ))\\r\\n    | extend IsError = (severityLevel == 3) or (levelText == \\\"error\\\")\\r\\n    | extend IsWarnMatch = (severityLevel == 2) and (tostring(message) has_any (WarnMsgs))\\r\\n    | extend Text = tostring(message)\\r\\n),\\r\\n(\\r\\n    exceptions\\r\\n    | where timestamp {TimeRange}\\r\\n    | extend IsError = true, IsWarnMatch = false, Text = tostring(outerMessage)\\r\\n),\\r\\n(\\r\\n    requests\\r\\n    | where timestamp {TimeRange}\\r\\n    | where success == false\\r\\n    | extend IsError = true, IsWarnMatch = false, Text = name\\r\\n),\\r\\n(\\r\\n    dependencies\\r\\n    | where timestamp {TimeRange}\\r\\n    | where success == false\\r\\n    | extend IsError = true, IsWarnMatch = false, Text = name\\r\\n)\\r\\n| where IsError or IsWarnMatch\\r\\n| where not(Text has_any (ExcludeMsgs))\\r\\n| summarize LogCount = count()\\r\\n    by bin(timestamp, 30m)\\r\\n| order by timestamp asc\",\"size\":0,\"color\":\"lightBlue\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.insights/components\",\"visualization\":\"unstackedbar\"},\"name\":\"query - 10\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"4eebb802-6dfe-4f94-85a6-42206fb3a2e9\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"SelectedError\",\"type\":1,\"timeContext\":{\"durationMs\":86400000},\"value\":\"Select an error group above\"}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.insights/components\"},\"name\":\"parameters - 6\"},{\"type\":1,\"content\":{\"json\":\"# Error Summary Dashboard\\r\\n\\r\\nSelected issue: {{SelectedError}}\\r\\nTime range: {{TimeRange}}\"},\"name\":\"text - 4\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"\\r\\nlet WarnMsgs = dynamic([\\r\\n    \\\"There was an error returned from customer's system\\\",\\r\\n    \\\"Failed to get response from method ProcessTransaction. Operation will be retried.\\\",\\r\\n    \\\"Failed to get response from method ProcessPayout. Operation will be retried.\\\",\\r\\n    \\\"Failed to get response from method CloseSession. Operation will be retried.\\\",\\r\\n    \\\"Failed to get response from method EndSession. Operation will be retried.\\\"\\r\\n]);\\r\\nlet ExcludeMsgs = dynamic([\\r\\n    \\\"User session does not exist\\\",\\r\\n    \\\"Unable to obtain user session\\\",\\r\\n    \\\"Getting currency rate from currency service failed.\\\"\\r\\n]);\\r\\nlet Results = \\r\\nunion isfuzzy=true\\r\\n(\\r\\n    traces\\r\\n    | where timestamp {TimeRange}\\r\\n    | extend levelText = tolower(coalesce(tostring(customDimensions[\\\"level\\\"]), tostring(customDimensions[\\\"Level\\\"]), tostring(customDimensions[\\\"loglevel\\\"]), tostring(customDimensions[\\\"LogLevel\\\"])))\\r\\n    | extend IsError = (severityLevel == 3) or (levelText == \\\"error\\\")\\r\\n    | extend IsWarnMatch = (severityLevel == 2) and (tostring(message) has_any (WarnMsgs))\\r\\n    | extend Text = tostring(message), Table = \\\"traces\\\", Role = cloud_RoleName\\r\\n    | project timestamp, Table, Role, cloud_RoleInstance, severityLevel, Text, operation_Id, _ResourceId, IsError, IsWarnMatch\\r\\n),\\r\\n(\\r\\n    exceptions\\r\\n    | where timestamp {TimeRange}\\r\\n    | extend Text = tostring(coalesce(outerMessage, innermostMessage, type, problemId, \\\"\\\"))\\r\\n    | extend Table = \\\"exceptions\\\", Role = cloud_RoleName, severityLevel = 3, IsError = true, IsWarnMatch = false\\r\\n    | project timestamp, Table, Role, cloud_RoleInstance, severityLevel, Text, operation_Id, _ResourceId, IsError, IsWarnMatch\\r\\n),\\r\\n(\\r\\n    requests\\r\\n    | where timestamp {TimeRange}\\r\\n    | where success == false\\r\\n    | extend Text = strcat(\\\"Request failed: \\\", name, \\\" (\\\", resultCode, \\\")\\\")\\r\\n    | extend Table = \\\"requests\\\", Role = cloud_RoleName, severityLevel = 3, IsError = true, IsWarnMatch = false\\r\\n    | project timestamp, Table, Role, cloud_RoleInstance, severityLevel, Text, operation_Id, _ResourceId, IsError, IsWarnMatch\\r\\n),\\r\\n(\\r\\n    dependencies\\r\\n    | where timestamp {TimeRange}\\r\\n    | where success == false\\r\\n    | extend Text = strcat(\\\"Dependency failed: \\\", name, \\\" (\\\", resultCode, \\\") - \\\", type, \\\" to \\\", target)\\r\\n    | extend Table = \\\"dependencies\\\", Role = cloud_RoleName, severityLevel = 3, IsError = true, IsWarnMatch = false\\r\\n    | project timestamp, Table, Role, cloud_RoleInstance, severityLevel, Text, operation_Id, _ResourceId, IsError, IsWarnMatch\\r\\n)\\r\\n| where IsError or IsWarnMatch\\r\\n| where not(Text has_any (ExcludeMsgs))\\r\\n| extend ResourceGroup = extract(@\\\"resourceGroups/([^/]+)/\\\", 1, _ResourceId),\\r\\n         AiComponent   = extract(@\\\"components/([^/]+)$\\\", 1, _ResourceId)\\r\\n| extend NormalizedText = replace_regex(Text, @\\\"'\\\\d+->\\\\d+'\\\", \\\"'N->N'\\\")\\r\\n| extend NormalizedText = replace_regex(NormalizedText, @\\\"\\\\b\\\\d+\\\\b\\\", \\\"N\\\")\\r\\n| extend NormalizedText = replace_regex(NormalizedText, @\\\"[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[1-5][0-9a-fA-F]{3}-[89abAB][0-9a-fA-F]{3}-[0-9a-fA-F]{12}\\\", \\\"GUID\\\")\\r\\n| extend GroupKey = case(\\r\\n    Text startswith \\\"Request failed: \\\", \\\"Request failed\\\",\\r\\n    Text startswith \\\"Dependency failed: \\\", \\\"Dependency failed\\\",\\r\\n    Text startswith \\\"Failed to send critical report files for customer \\\", \\\"Failed to send critical report files for customer\\\",\\r\\n    Text startswith \\\"SyncService: Failed to fetch currency rate for \\\", \\\"SyncService: Failed to fetch currency rate\\\",\\r\\n    Text startswith \\\"FeatureX functionality is disabled for customer \\\", \\\"FeatureX functionality is disabled for customer\\\",\\r\\n    Text startswith \\\"Response did not arrive on time in \\\", \\\"Response did not arrive on time in\\\",\\r\\n    NormalizedText\\r\\n);\\r\\nlet TotalHits = toscalar(Results | count);\\r\\nResults\\r\\n| summarize \\r\\n    Hits=count(), \\r\\n    FirstSeen=min(timestamp), \\r\\n    LastSeen=max(timestamp),\\r\\n    Roles=make_set(Role, 10), \\r\\n    Tables=make_set(Table, 4)\\r\\n    by GroupKey\\r\\n| extend Percentage = round(todouble(Hits) * 100.0 / todouble(TotalHits), 2)\\r\\n| project GroupKey, Hits, Percentage, FirstSeen, LastSeen, Roles, Tables\\r\\n| order by Hits desc\",\"size\":2,\"timeContextFromParameter\":\"TimeRange\",\"exportFieldName\":\"GroupKey\",\"exportParameterName\":\"SelectedError\",\"queryType\":0,\"resourceType\":\"microsoft.insights/components\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Error Type\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"OpenBlade\"}}],\"sortBy\":[{\"itemKey\":\"GroupKey\",\"sortOrder\":2}]},\"sortBy\":[{\"itemKey\":\"GroupKey\",\"sortOrder\":2}]},\"name\":\"query - 5\"},{\"type\":1,\"content\":{\"json\":\"---\\r\\n\\r\\n## ðŸ” Detailed Logs: {SelectedGroupKey}\\r\\n\\r\\nShowing all individual log entries for the selected error group.\\r\\n\\r\\n**Total logs shown below**\"},\"conditionalVisibility\":{\"parameterName\":\"A parameter value is set\",\"comparison\":\"isEqualTo\",\"value\":\"SelectedGroupKey\"},\"name\":\"text - 6\"},{\"type\":1,\"content\":{\"json\":\"## ðŸ” Detailed Logs: {SelectedError}\"},\"conditionalVisibility\":{\"parameterName\":\"A parameter value is set\",\"comparison\":\"isEqualTo\",\"value\":\"SelectedGroupKey\"},\"name\":\"text - 6\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let SelectedGroup = \\\"{SelectedError}\\\";\\r\\nlet WarnMsgs = dynamic([\\r\\n    \\\"There was an error returned from customer's system\\\",\\r\\n    \\\"Failed to get response from method ProcessTransaction. Operation will be retried.\\\",\\r\\n    \\\"Failed to get response from method ProcessPayout. Operation will be retried.\\\",\\r\\n    \\\"Failed to get response from method CloseSession. Operation will be retried.\\\",\\r\\n    \\\"Failed to get response from method EndSession. Operation will be retried.\\\"\\r\\n]);\\r\\nlet ExcludeMsgs = dynamic([\\r\\n    \\\"User session does not exist\\\",\\r\\n    \\\"Unable to obtain user session\\\",\\r\\n    \\\"Getting currency rate from currency service failed.\\\"\\r\\n]);\\r\\nlet ErrorCodeMapping = datatable(ErrorCode:string, ErrorTypeName:string)\\r\\n[\\r\\n    \\\"2003\\\", \\\"PlatformError\\\",\\r\\n    \\\"3010\\\", \\\"PlatformError\\\",\\r\\n    \\\"401\\\", \\\"AuthenticationError\\\",\\r\\n    \\\"403\\\", \\\"AuthorizationError\\\",\\r\\n    \\\"404\\\", \\\"NotFoundError\\\",\\r\\n    \\\"500\\\", \\\"ServerError\\\",\\r\\n    \\\"503\\\", \\\"ServiceUnavailable\\\"\\r\\n];\\r\\nunion isfuzzy=true\\r\\n(\\r\\n    traces\\r\\n    | where timestamp {TimeRange}\\r\\n    | extend customDims = todynamic(customDimensions)\\r\\n    | extend levelText = tolower(coalesce(\\r\\n        tostring(customDims[\\\"level\\\"]), \\r\\n        tostring(customDims[\\\"Level\\\"]), \\r\\n        tostring(customDims[\\\"loglevel\\\"]), \\r\\n        tostring(customDims[\\\"LogLevel\\\"])\\r\\n    ))\\r\\n    | extend IsError = (severityLevel == 3) or (levelText == \\\"error\\\")\\r\\n    | extend IsWarnMatch = (severityLevel == 2) and (tostring(message) has_any (WarnMsgs))\\r\\n    | extend \\r\\n        Text = tostring(message), \\r\\n        Table = \\\"traces\\\", \\r\\n        Role = cloud_RoleName,\\r\\n        ErrorId = tostring(customDims[\\\"ErrorId\\\"]),\\r\\n        UserId = tostring(customDims[\\\"UserId\\\"]),\\r\\n        SessionId = tostring(customDims[\\\"SessionId\\\"]),\\r\\n        OperationId = tostring(customDims[\\\"OperationId\\\"]),\\r\\n        TenantId = tostring(customDims[\\\"TenantId\\\"]),\\r\\n        Logger = tostring(customDims[\\\"CategoryName\\\"]),\\r\\n        HostName = cloud_RoleInstance,\\r\\n        SystemName = cloud_RoleName,\\r\\n        Environment = tostring(customDims[\\\"AspNetCoreEnvironment\\\"]),\\r\\n        GrainId = tostring(customDims[\\\"GrainId\\\"]),\\r\\n        ResponseBody = tostring(customDims[\\\"Response\\\"]),\\r\\n        ProblemId = \\\"\\\"\\r\\n    | extend ErrorCode = extract(@'\\\"code\\\":(\\\\d+)', 1, ResponseBody)\\r\\n    | extend ErrorTypePattern = case(\\r\\n        Text contains \\\"Timeout\\\" or Text contains \\\"timeout\\\" or Text contains \\\"request was canceled due to the configured HttpClient.Timeout\\\", \\\"PlatformTimeout\\\",\\r\\n        Text contains \\\"problem while connecting to customer\\\" or Text contains \\\"error returned from customer\\\" or Text contains \\\"error while connecting\\\", \\\"PlatformError\\\",\\r\\n        Text contains \\\"User session has expired\\\" or Text contains \\\"User session does not exist\\\", \\\"SessionError\\\",\\r\\n        Text contains \\\"Database Error\\\" or Text contains \\\"Failed to close transaction\\\", \\\"DatabaseError\\\",\\r\\n        Text contains \\\"Response status code does not indicate success\\\", \\\"ApiError\\\",\\r\\n        Text contains \\\"Object reference not set\\\", \\\"NullReferenceError\\\",\\r\\n        Text contains \\\"Parameter\\\" and Text contains \\\"is missing\\\", \\\"ValidationError\\\",\\r\\n        Text contains \\\"Parameter\\\" and Text contains \\\"invalid\\\", \\\"ValidationError\\\",\\r\\n        Text contains \\\"disabled for customer\\\" or Text contains \\\"does not exist\\\" or Text contains \\\"is not enabled\\\", \\\"ConfigurationError\\\",\\r\\n        \\\"\\\"\\r\\n    )\\r\\n    | project timestamp, Table, Role, cloud_RoleInstance, Text, operation_Id, IsError, IsWarnMatch,\\r\\n              ErrorId, ErrorCode, ErrorTypePattern, UserId, SessionId, OperationId, TenantId, Logger, HostName, SystemName, Environment, GrainId, ProblemId\\r\\n),\\r\\n(\\r\\n    exceptions\\r\\n    | where timestamp {TimeRange}\\r\\n    | extend customDims = todynamic(customDimensions)\\r\\n    | extend \\r\\n        Text = tostring(coalesce(outerMessage, innermostMessage, type, problemId, \\\"\\\")),\\r\\n        Table = \\\"exceptions\\\", \\r\\n        Role = cloud_RoleName, \\r\\n        IsError = true, \\r\\n        IsWarnMatch = false,\\r\\n        ErrorId = tostring(customDims[\\\"ErrorId\\\"]),\\r\\n        UserId = tostring(customDims[\\\"UserId\\\"]),\\r\\n        SessionId = tostring(customDims[\\\"SessionId\\\"]),\\r\\n        OperationId = tostring(customDims[\\\"OperationId\\\"]),\\r\\n        TenantId = tostring(customDims[\\\"TenantId\\\"]),\\r\\n        Logger = tostring(customDims[\\\"CategoryName\\\"]),\\r\\n        HostName = cloud_RoleInstance,\\r\\n        SystemName = cloud_RoleName,\\r\\n        Environment = tostring(customDims[\\\"AspNetCoreEnvironment\\\"]),\\r\\n        GrainId = tostring(customDims[\\\"GrainId\\\"]),\\r\\n        PlatformType = tostring(customDims[\\\"PlatformTypeName\\\"]),\\r\\n        PlatformVersion = tostring(customDims[\\\"PlatformVersion\\\"]),\\r\\n        ExceptionType = type,\\r\\n        ExceptionMessage = outerMessage,\\r\\n        InnerMessage = innermostMessage,\\r\\n        ResponseBody = tostring(customDims[\\\"Response\\\"]),\\r\\n        ProblemId = problemId\\r\\n    | extend ErrorCode = extract(@'\\\"code\\\":(\\\\d+)', 1, ResponseBody)\\r\\n    | extend ErrorTypePattern = case(\\r\\n        Text contains \\\"Timeout\\\" or Text contains \\\"timeout\\\" or Text contains \\\"request was canceled due to the configured HttpClient.Timeout\\\" or ExceptionType contains \\\"TimeoutException\\\", \\\"PlatformTimeout\\\",\\r\\n        Text contains \\\"problem while connecting to customer\\\" or Text contains \\\"error returned from customer\\\" or Text contains \\\"error while connecting to customer platform\\\" or ProblemId contains \\\"App.Platforms\\\", \\\"PlatformError\\\",\\r\\n        Text contains \\\"User session has expired\\\" or Text contains \\\"User session does not exist\\\" or Text contains \\\"Failed to close user session\\\", \\\"SessionError\\\",\\r\\n        Text contains \\\"Database Error\\\" or Text contains \\\"Failed to close transaction\\\" or Text contains \\\"inconsistent state\\\", \\\"DatabaseError\\\",\\r\\n        Text contains \\\"Response status code does not indicate success\\\" or Text contains \\\"BadRequest\\\" or Text contains \\\"InternalServerError\\\", \\\"ApiError\\\",\\r\\n        Text contains \\\"Object reference not set\\\" or ExceptionType contains \\\"NullReferenceException\\\", \\\"NullReferenceError\\\",\\r\\n        (Text contains \\\"Parameter\\\" and Text contains \\\"is missing\\\") or (Text contains \\\"Parameter\\\" and Text contains \\\"invalid\\\") or ExceptionType contains \\\"ArgumentException\\\", \\\"ValidationError\\\",\\r\\n        Text contains \\\"Invalid\\\" and (Text contains \\\"Token\\\" or Text contains \\\"TicketId\\\"), \\\"AuthenticationError\\\",\\r\\n        Text contains \\\"disabled for customer\\\" or Text contains \\\"does not exist\\\" or Text contains \\\"is not enabled\\\" or Text contains \\\"Configuration\\\", \\\"ConfigurationError\\\",\\r\\n        Text contains \\\"not enough money\\\" or Text contains \\\"limit was reached\\\", \\\"BusinessRuleError\\\",\\r\\n        Text contains \\\"client has disconnected\\\", \\\"ClientDisconnected\\\",\\r\\n        ExceptionType contains \\\"InvalidOperationException\\\", \\\"PlatformError\\\",\\r\\n        \\\"\\\"\\r\\n    )\\r\\n    | project timestamp, Table, Role, cloud_RoleInstance, Text, operation_Id, IsError, IsWarnMatch,\\r\\n              ErrorId, ErrorCode, ErrorTypePattern, UserId, SessionId, OperationId, TenantId, Logger, HostName, SystemName, Environment, GrainId,\\r\\n              PlatformType, PlatformVersion, ExceptionType, ExceptionMessage, InnerMessage, ProblemId\\r\\n),\\r\\n(\\r\\n    requests\\r\\n    | where timestamp {TimeRange}\\r\\n    | where success == false\\r\\n    | extend customDims = todynamic(customDimensions)\\r\\n    | extend \\r\\n        Text = strcat(\\\"Request failed: \\\", name, \\\" (\\\", resultCode, \\\")\\\"),\\r\\n        Table = \\\"requests\\\", \\r\\n        Role = cloud_RoleName, \\r\\n        IsError = true, \\r\\n        IsWarnMatch = false,\\r\\n        ErrorId = \\\"\\\",\\r\\n        UserId = tostring(customDims[\\\"UserId\\\"]),\\r\\n        SessionId = tostring(customDims[\\\"SessionId\\\"]),\\r\\n        OperationId = tostring(customDims[\\\"OperationId\\\"]),\\r\\n        TenantId = \\\"\\\",\\r\\n        Logger = \\\"\\\",\\r\\n        HostName = cloud_RoleInstance,\\r\\n        SystemName = cloud_RoleName,\\r\\n        Environment = tostring(customDims[\\\"AspNetCoreEnvironment\\\"]),\\r\\n        GrainId = \\\"\\\",\\r\\n        ProblemId = \\\"\\\"\\r\\n    | extend ErrorCode = resultCode\\r\\n    | extend ErrorTypePattern = case(\\r\\n        resultCode == \\\"401\\\", \\\"AuthenticationError\\\",\\r\\n        resultCode == \\\"403\\\", \\\"AuthorizationError\\\",\\r\\n        resultCode == \\\"404\\\", \\\"NotFoundError\\\",\\r\\n        resultCode == \\\"400\\\", \\\"ValidationError\\\",\\r\\n        resultCode == \\\"500\\\", \\\"ServerError\\\",\\r\\n        resultCode == \\\"503\\\", \\\"ServiceUnavailable\\\",\\r\\n        resultCode == \\\"499\\\", \\\"ClientClosedRequest\\\",\\r\\n        \\\"RequestFailure\\\"\\r\\n    )\\r\\n    | project timestamp, Table, Role, cloud_RoleInstance, Text, operation_Id, IsError, IsWarnMatch,\\r\\n              ErrorId, ErrorCode, ErrorTypePattern, UserId, SessionId, OperationId, TenantId, Logger, HostName, SystemName, Environment, GrainId, ProblemId\\r\\n),\\r\\n(\\r\\n    dependencies\\r\\n    | where timestamp {TimeRange}\\r\\n    | where success == false\\r\\n    | extend customDims = todynamic(customDimensions)\\r\\n    | extend \\r\\n        Text = strcat(\\\"Dependency failed: \\\", name, \\\" (\\\", resultCode, \\\") - \\\", type, \\\" to \\\", target),\\r\\n        Table = \\\"dependencies\\\", \\r\\n        Role = cloud_RoleName, \\r\\n        IsError = true, \\r\\n        IsWarnMatch = false,\\r\\n        ErrorId = \\\"\\\",\\r\\n        UserId = \\\"\\\",\\r\\n        SessionId = \\\"\\\",\\r\\n        OperationId = \\\"\\\",\\r\\n        TenantId = \\\"\\\",\\r\\n        Logger = \\\"\\\",\\r\\n        HostName = cloud_RoleInstance,\\r\\n        SystemName = cloud_RoleName,\\r\\n        Environment = \\\"\\\",\\r\\n        GrainId = \\\"\\\",\\r\\n        ProblemId = \\\"\\\"\\r\\n    | extend ErrorCode = resultCode\\r\\n    | extend ErrorTypePattern = case(\\r\\n        resultCode == \\\"401\\\", \\\"AuthenticationError\\\",\\r\\n        resultCode == \\\"500\\\", \\\"ServerError\\\",\\r\\n        resultCode == \\\"Canceled\\\" or resultCode contains \\\"Timeout\\\", \\\"DependencyTimeout\\\",\\r\\n        \\\"DependencyFailure\\\"\\r\\n    )\\r\\n    | project timestamp, Table, Role, cloud_RoleInstance, Text, operation_Id, IsError, IsWarnMatch,\\r\\n              ErrorId, ErrorCode, ErrorTypePattern, UserId, SessionId, OperationId, TenantId, Logger, HostName, SystemName, Environment, GrainId, ProblemId\\r\\n)\\r\\n| where IsError or IsWarnMatch\\r\\n| where not(Text has_any (ExcludeMsgs))\\r\\n| extend NormalizedText = replace_regex(Text, @\\\"'\\\\d+->\\\\d+'\\\", \\\"'N->N'\\\")\\r\\n| extend NormalizedText = replace_regex(NormalizedText, @\\\"\\\\b\\\\d+\\\\b\\\", \\\"N\\\")\\r\\n| extend NormalizedText = replace_regex(NormalizedText, @\\\"[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[1-5][0-9a-fA-F]{3}-[89abAB][0-9a-fA-F]{3}-[0-9a-fA-F]{12}\\\", \\\"GUID\\\")\\r\\n| extend GroupKey = case(\\r\\n    Text startswith \\\"Request failed: \\\", \\\"Request failed\\\",\\r\\n    Text startswith \\\"Dependency failed: \\\", \\\"Dependency failed\\\",\\r\\n    Text startswith \\\"Failed to send critical report files for customer \\\", \\\"Failed to send critical report files for customer\\\",\\r\\n    Text startswith \\\"SyncService: Failed to fetch currency rate for \\\", \\\"SyncService: Failed to fetch currency rate\\\",\\r\\n    Text startswith \\\"FeatureX functionality is disabled for customer \\\", \\\"FeatureX functionality is disabled for customer\\\",\\r\\n    Text startswith \\\"Response did not arrive on time in \\\", \\\"Response did not arrive on time in\\\",\\r\\n    NormalizedText\\r\\n)\\r\\n| join kind=leftouter ErrorCodeMapping on ErrorCode\\r\\n| extend ErrorType = coalesce(ErrorTypeName, ErrorTypePattern, \\\"Unknown\\\")\\r\\n| where isnotempty(SelectedGroup) and GroupKey == SelectedGroup\\r\\n| project \\r\\n    timestamp,\\r\\n    Text,\\r\\n    Table,\\r\\n    ErrorType,\\r\\n    ErrorCode,\\r\\n    ErrorId,\\r\\n    UserId,\\r\\n    SessionId,\\r\\n    OperationId,\\r\\n    TenantId,\\r\\n    Logger,\\r\\n    HostName,\\r\\n    SystemName,\\r\\n    Environment,\\r\\n    GrainId,\\r\\n    ProblemId,\\r\\n    operation_Id,\\r\\n    Role\\r\\n| order by timestamp desc\",\"size\":2,\"timeContext\":{\"durationMs\":86400000},\"queryType\":0,\"resourceType\":\"microsoft.insights/components\",\"gridSettings\":{\"rowLimit\":10000}},\"conditionalVisibility\":{\"parameterName\":\"SelectedError\",\"comparison\":\"isNotEqualTo\",\"value\":\"\"},\"name\":\"query - 7\"}],\"isLocked\":false,\"fallbackResourceIds\":[\"WORKBOOK_SOURCE_ID_PLACEHOLDER\"]}"
  },
  "resources": [
    {
      "name": "[parameters('workbookId')]",
      "type": "microsoft.insights/workbooks",
      "location": "[resourceGroup().location]",
      "apiVersion": "2022-04-01",
      "dependsOn": [],
      "kind": "shared",
      "properties": {
        "displayName": "[parameters('workbookDisplayName')]",
        "serializedData": "[replace(variables('serializedDataTemplate'), 'WORKBOOK_SOURCE_ID_PLACEHOLDER', parameters('workbookSourceId'))]",
        "version": "1.0",
        "sourceId": "[parameters('workbookSourceId')]",
        "category": "[parameters('workbookType')]"
      }
    }
  ],
  "outputs": {
    "workbookId": {
      "type": "string",
      "value": "[resourceId('microsoft.insights/workbooks', parameters('workbookId'))]"
    }
  }
}